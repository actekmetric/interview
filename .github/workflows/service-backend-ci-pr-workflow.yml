name: Backend Service PR CI/CD

on:
  pull_request:
    paths:
      - 'backend/**'
      - 'sre/helm/backend/**'
      - 'sre/k8s/**'
      - 'sre/scripts/**'
      - '.github/workflows/service-backend-ci-pr-workflow.yml'

  workflow_dispatch:

jobs:
  build-and-test:
    name: Build and Unit Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 8
        uses: actions/setup-java@v4
        with:
          java-version: '8'
          distribution: 'temurin'
          cache: 'maven'

      - name: Build with Maven
        working-directory: ./backend
        run: mvn clean package -DskipTests

      - name: Run unit tests
        working-directory: ./backend
        run: mvn test

      - name: Get version from pom.xml
        id: get_version
        working-directory: ./backend
        run: |
          VERSION=$(mvn help:evaluate -Dexpression=project.version -q -DforceStdout)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "artifact_name=interview-$VERSION.jar" >> $GITHUB_OUTPUT

      - name: Upload JAR as artifact
        uses: actions/upload-artifact@v4
        with:
          name: backend-jar
          path: backend/target/*.jar
          retention-days: 7

      - name: Generate build summary
        run: |
          echo "# Backend Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Build Information" >> $GITHUB_STEP_SUMMARY
          echo "- **Version:** ${{ steps.get_version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **JAR:** \`${{ steps.get_version.outputs.artifact_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** ${{ github.head_ref }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "✅ Build and tests completed successfully" >> $GITHUB_STEP_SUMMARY

  deployment-test:
    name: Deployment Testing
    runs-on: ubuntu-latest
    needs: build-and-test
    timeout-minutes: 15
    permissions:
      contents: write
      packages: write
      pages: write
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 8
        uses: actions/setup-java@v4
        with:
          java-version: '8'
          distribution: 'temurin'

      - name: Download JAR artifact
        uses: actions/download-artifact@v4
        with:
          name: backend-jar
          path: backend/target

      - name: Get version from pom.xml
        id: get_version
        working-directory: ./backend
        run: |
          VERSION=$(mvn help:evaluate -Dexpression=project.version -q -DforceStdout)
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Pre-cleanup
        run: |
          k3d cluster delete backend-test 2>/dev/null || true

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push Docker image for PR testing
        working-directory: ./backend
        run: |
          # Build and push PR image to GHCR for testing
          docker build --platform linux/amd64 -t ghcr.io/${{ github.repository_owner }}/backend:pr-${{ github.run_number }} -f docker/Dockerfile .
          docker push ghcr.io/${{ github.repository_owner }}/backend:pr-${{ github.run_number }}

      - name: Install Trivy
        run: |
          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /usr/local/bin

      - name: Scan Docker image with Trivy
        continue-on-error: true
        run: |
          echo "# Security Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Docker Image Vulnerabilities" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "> **Note:** Base image vulnerabilities (Alpine 3.9.4 / OpenJDK 8u212) are known and tracked separately." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          trivy image --severity HIGH,CRITICAL --format table ghcr.io/${{ github.repository_owner }}/backend:pr-${{ github.run_number }} | tee -a $GITHUB_STEP_SUMMARY || true
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Scan but don't fail the workflow - base image has known CVEs
          # Focus on application-level vulnerabilities (Java dependencies)
          trivy image --severity HIGH,CRITICAL \
            --exit-code 0 \
            --format sarif --output trivy-results.sarif \
            ghcr.io/${{ github.repository_owner }}/backend:pr-${{ github.run_number }}

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: trivy-results.sarif

      - name: Install k3d
        run: |
          curl -s https://raw.githubusercontent.com/k3d-io/k3d/main/install.sh | bash

      - name: Create k3d cluster
        run: |
          k3d cluster create backend-test \
            --agents 0 \
            --k3s-arg "--disable=traefik,metrics-server@server:0" \
            --port 8080:30080@loadbalancer \
            --wait \
            --timeout 1m

      - name: Verify k3d cluster
        run: |
          kubectl cluster-info
          kubectl get nodes
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Kubernetes Cluster" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          kubectl get nodes >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

      - name: Install Helm
        uses: azure/setup-helm@v3
        with:
          version: 'v3.13.0'

      - name: Update chart version for PR
        working-directory: ./sre/helm/backend
        run: |
          # Update chart version to include PR number
          sed -i.bak "s/^version:.*/version: 0.1.0-pr${{ github.run_number }}/" Chart.yaml

      - name: Add Helm repository for dependencies
        run: |
          # Add the GitHub Pages helm repository
          helm repo add tekmetric https://actekmetric.github.io/interview/
          helm repo update

      - name: Build Helm dependencies
        working-directory: ./sre/helm/backend
        run: |
          helm dependency build

      - name: Configure Git for chart-releaser
        run: |
          git config user.name "$GITHUB_ACTOR"
          git config user.email "$GITHUB_ACTOR@users.noreply.github.com"

      - name: Package and publish Helm chart to GitHub Pages
        uses: helm/chart-releaser-action@v1.6.0
        with:
          charts_dir: sre/helm
        env:
          CR_TOKEN: "${{ secrets.GITHUB_TOKEN }}"
          CR_SKIP_EXISTING: false

      - name: Deploy backend with Helm
        working-directory: ./sre/helm/backend
        run: |
          helm install backend . \
            --values values-local-kind-testing.yaml \
            --set tekmetric-common-chart.image.repository=ghcr.io/${{ github.repository_owner }} \
            --set tekmetric-common-chart.image.tag=pr-${{ github.run_number }} \
            --wait \
            --timeout 5m \
            --debug

      - name: Verify Kubernetes resources
        run: |
          echo "=== Deployments ==="
          kubectl get deployments -A

          echo "=== Pods ==="
          kubectl get pods -A

          echo "=== Services ==="
          kubectl get services -A

      - name: Wait for deployment
        run: |
          kubectl wait --for=condition=available --timeout=300s \
            deployment/backend -n default

      - name: Wait for pod ready
        run: |
          kubectl wait --for=condition=ready --timeout=300s \
            pod -l app.kubernetes.io/name=backend -n default

      - name: Check pod logs
        if: always()
        run: |
          echo "=== Pod Logs ==="
          kubectl logs -l app.kubernetes.io/name=backend --tail=100 -n default || true

      - name: Port forward backend service
        run: |
          kubectl port-forward service/backend 8080:8080 -n default &
          sleep 10

      - name: Run smoke tests
        run: |
          chmod +x sre/scripts/smoke-tests.sh
          ./sre/scripts/smoke-tests.sh

      - name: Generate deployment test summary
        if: always()
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Deployment Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Image:** \`backend:pr-${{ github.run_number }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Cluster:** k3d (backend-test)" >> $GITHUB_STEP_SUMMARY
          echo "- **Namespace:** default" >> $GITHUB_STEP_SUMMARY
          echo "- **Helm Chart:** sre/helm/backend" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ job.status }}" == "success" ]; then
            echo "✅ All deployment tests passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ Deployment tests failed" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Cleanup - Delete k3d cluster
        if: always()
        run: |
          k3d cluster delete backend-test 2>/dev/null || true

      - name: Cleanup - Remove local Docker images
        if: always()
        run: |
          docker rmi ghcr.io/${{ github.repository_owner }}/backend:pr-${{ github.run_number }} 2>/dev/null || true
          docker system prune -f 2>/dev/null || true

      - name: Cleanup - Delete PR image from GHCR
        if: always()
        continue-on-error: true
        run: |
          # Delete the PR image from GHCR after tests complete
          # Requires: contents: write, packages: write permissions
          gh api --method DELETE \
            /orgs/${{ github.repository_owner }}/packages/container/backend/versions/$(gh api /orgs/${{ github.repository_owner }}/packages/container/backend/versions | jq -r '.[] | select(.metadata.container.tags[] | contains("pr-${{ github.run_number }}")) | .id') \
            2>/dev/null || echo "Could not delete PR image from GHCR (may require packages: write permission)"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Cleanup - Delete PR Helm chart from GitHub Pages
        if: always()
        continue-on-error: true
        run: |
          # Delete the PR Helm chart release from GitHub
          CHART_VERSION="0.1.0-pr${{ github.run_number }}"
          TAG_NAME="backend-service-${CHART_VERSION}"

          # Delete the GitHub release and tag for the chart
          gh release delete "$TAG_NAME" --yes 2>/dev/null || echo "Chart release not found or already deleted"
          git push --delete origin "$TAG_NAME" 2>/dev/null || echo "Chart tag not found or already deleted"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
