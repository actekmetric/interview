name: Common Helm Chart CI/CD

on:
  push:
    branches:
      - master
      - main
    paths:
      - 'sre/helm/common/charts/tekmetric-common-chart/**'
      - '.github/workflows/sre-helm-common-chart.yml'

  workflow_dispatch:

# Cancel previous runs for the same branch/PR
concurrency:
  group: common-chart-${{ github.ref }}
  cancel-in-progress: true

jobs:
  publish-helm-chart:
    name: Publish Common Helm Chart
    runs-on: ubuntu-latest
    if: (github.event_name == 'push' || github.event_name == 'workflow_dispatch') && (github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main')
    permissions:
      contents: write
      pages: write
    outputs:
      chart-version: ${{ steps.get-version.outputs.version }}
      chart-name: ${{ steps.get-version.outputs.name }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config user.name "$GITHUB_ACTOR"
          git config user.email "$GITHUB_ACTOR@users.noreply.github.com"

      - name: Install Helm
        uses: azure/setup-helm@v3
        with:
          version: v3.14.0

      - name: Lint Helm Chart
        run: |
          echo "ðŸ” Linting Helm chart..."
          helm lint sre/helm/common/charts/tekmetric-common-chart/
          echo "âœ… Helm chart linting passed"

      - name: Get Chart Info
        id: get-version
        run: |
          CHART_NAME=$(helm show chart sre/helm/common/charts/tekmetric-common-chart | grep '^name:' | awk '{print $2}')
          CHART_VERSION=$(helm show chart sre/helm/common/charts/tekmetric-common-chart | grep '^version:' | awk '{print $2}')
          APP_VERSION=$(helm show chart sre/helm/common/charts/tekmetric-common-chart | grep '^appVersion:' | awk '{print $2}' | tr -d '"')

          echo "name=${CHART_NAME}" >> $GITHUB_OUTPUT
          echo "version=${CHART_VERSION}" >> $GITHUB_OUTPUT
          echo "app-version=${APP_VERSION}" >> $GITHUB_OUTPUT

          echo "ðŸ“¦ Chart: ${CHART_NAME}"
          echo "ðŸ·ï¸  Version: ${CHART_VERSION}"
          echo "ðŸ³ App Version: ${APP_VERSION}"

      - name: Validate Chart Template
        run: |
          echo "ðŸ” Validating Helm chart templates..."
          helm template test-release sre/helm/common/charts/tekmetric-common-chart --dry-run > /dev/null
          echo "âœ… Helm chart templates are valid"

      - name: Run chart-releaser
        uses: helm/chart-releaser-action@v1.6.0
        with:
          charts_dir: sre/helm/common/charts
        env:
          CR_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CR_SKIP_EXISTING: true

      - name: Summary
        run: |
          echo "## ðŸ“¦ Common Helm Chart Published" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Chart Name:** \`${{ steps.get-version.outputs.name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Chart Version:** \`${{ steps.get-version.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**App Version:** \`${{ steps.get-version.outputs.app-version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Repository:** https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¥ Add as Dependency" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`yaml" >> $GITHUB_STEP_SUMMARY
          echo "dependencies:" >> $GITHUB_STEP_SUMMARY
          echo "  - name: ${{ steps.get-version.outputs.name }}" >> $GITHUB_STEP_SUMMARY
          echo "    version: \"${{ steps.get-version.outputs.version }}\"" >> $GITHUB_STEP_SUMMARY
          echo "    repository: \"https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/\"" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

  workflow-summary:
    name: Workflow Summary
    runs-on: ubuntu-latest
    needs: [publish-helm-chart]
    if: always()

    steps:
      - name: Generate Workflow Summary
        run: |
          echo "## ðŸš€ Common Helm Chart CI/CD Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** [\`${GITHUB_SHA::8}\`](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }})" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by:** ${{ github.event_name }} (${{ github.actor }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### Job Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY

          # Publish Helm Chart
          if [[ "${{ needs.publish-helm-chart.result }}" == "success" ]]; then
            echo "| Publish Common Chart | âœ… Success |" >> $GITHUB_STEP_SUMMARY
          elif [[ "${{ needs.publish-helm-chart.result }}" == "failure" ]]; then
            echo "| Publish Common Chart | âŒ Failed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Publish Common Chart | â­ï¸ Skipped |" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
