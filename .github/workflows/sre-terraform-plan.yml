name: Terraform Plan

on:
  pull_request:
    branches:
      - master
      - main
    paths:
      - 'sre/terraform/modules/**'
      - 'sre/terragrunt/environments/dev/**'
      # Uncomment when ready to enable QA
      # - 'sre/terragrunt/environments/qa/**'
      # Uncomment when ready to enable Prod
      # - 'sre/terragrunt/environments/prod/**'
      - '.github/workflows/sre-terraform-plan.yml'
      - '.github/actions/terraform-setup/**'
      - '.github/actions/aws-assume-role/**'

  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to plan'
        required: true
        type: choice
        options:
          - dev
          - qa
          - prod

concurrency:
  group: terraform-plan-${{ github.ref }}
  cancel-in-progress: true

jobs:
  validate:
    name: Validate Terraform
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform and Terragrunt
        uses: ./.github/actions/terraform-setup

      - name: Terraform format check
        run: |
          echo "ðŸ” Checking Terraform formatting..."
          terraform fmt -check -recursive sre/terraform/
          echo "âœ… Terraform formatting is correct"

      - name: Validate Terraform modules
        run: |
          echo "ðŸ” Validating Terraform modules..."
          for module in sre/terraform/modules/*/; do
            echo "Validating $module"
            cd $module
            terraform init -backend=false
            terraform validate
            cd -
          done
          echo "âœ… All modules are valid"

  plan-dev:
    name: Plan Dev
    runs-on: ubuntu-latest
    needs: validate
    if: github.event.inputs.environment == '' || github.event.inputs.environment == 'dev'
    permissions:
      id-token: write
      contents: read
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform and Terragrunt
        uses: ./.github/actions/terraform-setup

      - name: Assume AWS Role
        uses: ./.github/actions/aws-assume-role
        with:
          environment: dev

      - name: Terragrunt Plan
        id: plan
        run: |
          cd sre/terragrunt/environments/dev
          terragrunt run-all plan --terragrunt-non-interactive

      - name: Comment PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '## Terraform Plan: Dev\n\nâœ… Plan completed successfully.\nSee job logs for details.'
            })

  plan-qa:
    name: Plan QA
    runs-on: ubuntu-latest
    needs: validate
    if: github.event.inputs.environment == '' || github.event.inputs.environment == 'qa'
    permissions:
      id-token: write
      contents: read
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform and Terragrunt
        uses: ./.github/actions/terraform-setup

      - name: Assume AWS Role
        uses: ./.github/actions/aws-assume-role
        with:
          environment: qa

      - name: Terragrunt Plan
        run: |
          cd sre/terragrunt/environments/qa
          terragrunt run-all plan --terragrunt-non-interactive

  plan-prod:
    name: Plan Prod
    runs-on: ubuntu-latest
    needs: validate
    if: github.event.inputs.environment == '' || github.event.inputs.environment == 'prod'
    permissions:
      id-token: write
      contents: read
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform and Terragrunt
        uses: ./.github/actions/terraform-setup

      - name: Assume AWS Role
        uses: ./.github/actions/aws-assume-role
        with:
          environment: prod

      - name: Terragrunt Plan
        run: |
          cd sre/terragrunt/environments/prod
          terragrunt run-all plan --terragrunt-non-interactive

  summary:
    name: Plan Summary
    runs-on: ubuntu-latest
    needs: [validate, plan-dev, plan-qa, plan-prod]
    if: always()

    steps:
      - name: Generate Summary
        run: |
          echo "## ðŸ—ºï¸ Terraform Plan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Job Status" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Validate | ${{ needs.validate.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Dev | ${{ needs.plan-dev.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| QA | ${{ needs.plan-qa.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Prod | ${{ needs.plan-prod.result }} |" >> $GITHUB_STEP_SUMMARY
