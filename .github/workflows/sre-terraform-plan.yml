name: Terraform Plan & Apply

on:
  pull_request:
    branches:
      - master
      - main
    paths:
      - 'sre/terraform/modules/**'
      - 'sre/terragrunt/environments/dev/**'
      # Uncomment when ready to enable QA
      # - 'sre/terragrunt/environments/qa/**'
      # Uncomment when ready to enable Prod
      # - 'sre/terragrunt/environments/prod/**'
      - '.github/workflows/sre-terraform-plan.yml'
      - '.github/actions/terraform-setup/**'
      - '.github/actions/aws-assume-role/**'

  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to plan/apply'
        required: true
        type: choice
        options:
          - dev
          - qa
          - prod
      action:
        description: 'Action to perform'
        required: true
        type: choice
        options:
          - plan
          - apply
        default: plan

concurrency:
  group: terraform-${{ github.event.inputs.environment || 'dev' }}
  cancel-in-progress: false

jobs:
  validate:
    name: Validate Terraform
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform and Terragrunt
        uses: ./.github/actions/terraform-setup

      - name: Terraform format check
        run: |
          echo "ðŸ” Checking Terraform formatting..."
          terraform fmt -check -recursive sre/terraform/
          echo "âœ… Terraform formatting is correct"

      - name: Validate Terraform modules
        run: |
          echo "ðŸ” Validating Terraform modules..."
          for module in sre/terraform/modules/*/; do
            echo "Validating $module"
            cd $module
            terraform init -backend=false
            terraform validate
            cd -
          done
          echo "âœ… All modules are valid"

  plan-dev:
    name: Plan Dev
    runs-on: ubuntu-latest
    needs: validate
    if: |
      (github.event_name == 'pull_request') ||
      (github.event.inputs.environment == 'dev' && github.event.inputs.action == 'plan')
    permissions:
      id-token: write
      contents: read
      pull-requests: write
    environment:
      name: dev

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform and Terragrunt
        uses: ./.github/actions/terraform-setup

      - name: Assume AWS Role
        uses: ./.github/actions/aws-assume-role
        with:
          environment: dev
          role-arn: ${{ secrets.AWS_DEV_ROLE_ARN }}
          account-id: ${{ secrets.AWS_DEV_ACCOUNT_ID }}

      - name: Terragrunt Plan
        id: plan
        run: |
          cd sre/terragrunt/environments/dev
          terragrunt run-all plan --terragrunt-non-interactive

      - name: Comment PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '## ðŸ—ºï¸ Terraform Plan: Dev\n\nâœ… Plan completed successfully.\n\n**Next Steps:**\n- Review the plan in the job logs\n- To apply, go to Actions â†’ This workflow â†’ Run workflow â†’ Select "dev" + "apply"\n\nSee [job logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for details.'
            })

  apply-dev:
    name: Apply Dev
    runs-on: ubuntu-latest
    needs: validate
    if: |
      github.event.inputs.environment == 'dev' && github.event.inputs.action == 'apply'
    permissions:
      id-token: write
      contents: read
      pull-requests: write
    environment:
      name: dev
      url: https://console.aws.amazon.com/eks/home?region=us-east-1#/clusters/tekmetric-dev

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform and Terragrunt
        uses: ./.github/actions/terraform-setup

      - name: Assume AWS Role
        uses: ./.github/actions/aws-assume-role
        with:
          environment: dev
          role-arn: ${{ secrets.AWS_DEV_ROLE_ARN }}
          account-id: ${{ secrets.AWS_DEV_ACCOUNT_ID }}

      - name: Terragrunt Apply
        run: |
          cd sre/terragrunt/environments/dev
          terragrunt run-all apply --terragrunt-non-interactive

      - name: Comment PR
        if: github.event.pull_request
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '## âœ… Terraform Applied: Dev\n\nðŸš€ Infrastructure has been successfully applied to Dev environment.\n\nSee [job logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for details.'
            })

      - name: Summary
        run: |
          echo "## âœ… Dev Infrastructure Applied" >> $GITHUB_STEP_SUMMARY
          echo "**Cluster:** tekmetric-dev" >> $GITHUB_STEP_SUMMARY
          echo "**Region:** us-east-1" >> $GITHUB_STEP_SUMMARY

  plan-qa:
    name: Plan QA
    runs-on: ubuntu-latest
    needs: plan-dev
    if: |
      github.event.inputs.environment == 'qa' && github.event.inputs.action == 'plan'
    permissions:
      id-token: write
      contents: read
      pull-requests: write
    environment:
      name: qa

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform and Terragrunt
        uses: ./.github/actions/terraform-setup

      - name: Assume AWS Role
        uses: ./.github/actions/aws-assume-role
        with:
          environment: qa
          role-arn: ${{ secrets.AWS_QA_ROLE_ARN }}
          account-id: ${{ secrets.AWS_QA_ACCOUNT_ID }}

      - name: Terragrunt Plan
        run: |
          cd sre/terragrunt/environments/qa
          terragrunt run-all plan --terragrunt-non-interactive

  apply-qa:
    name: Apply QA
    runs-on: ubuntu-latest
    needs: apply-dev
    if: |
      github.event.inputs.environment == 'qa' && github.event.inputs.action == 'apply'
    permissions:
      id-token: write
      contents: read
    environment:
      name: qa
      url: https://console.aws.amazon.com/eks/home?region=us-east-1#/clusters/tekmetric-qa

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform and Terragrunt
        uses: ./.github/actions/terraform-setup

      - name: Assume AWS Role
        uses: ./.github/actions/aws-assume-role
        with:
          environment: qa
          role-arn: ${{ secrets.AWS_QA_ROLE_ARN }}
          account-id: ${{ secrets.AWS_QA_ACCOUNT_ID }}

      - name: Terragrunt Apply
        run: |
          cd sre/terragrunt/environments/qa
          terragrunt run-all apply --terragrunt-non-interactive

      - name: Summary
        run: |
          echo "## âœ… QA Infrastructure Applied" >> $GITHUB_STEP_SUMMARY
          echo "**Cluster:** tekmetric-qa" >> $GITHUB_STEP_SUMMARY
          echo "**Region:** us-east-1" >> $GITHUB_STEP_SUMMARY

  plan-prod:
    name: Plan Prod
    runs-on: ubuntu-latest
    needs: plan-qa
    if: |
      github.event.inputs.environment == 'prod' && github.event.inputs.action == 'plan'
    permissions:
      id-token: write
      contents: read
      pull-requests: write
    environment:
      name: prod

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform and Terragrunt
        uses: ./.github/actions/terraform-setup

      - name: Assume AWS Role
        uses: ./.github/actions/aws-assume-role
        with:
          environment: prod
          role-arn: ${{ secrets.AWS_PROD_ROLE_ARN }}
          account-id: ${{ secrets.AWS_PROD_ACCOUNT_ID }}

      - name: Terragrunt Plan
        run: |
          cd sre/terragrunt/environments/prod
          terragrunt run-all plan --terragrunt-non-interactive

  apply-prod:
    name: Apply Prod
    runs-on: ubuntu-latest
    needs: apply-qa
    if: |
      github.event.inputs.environment == 'prod' && github.event.inputs.action == 'apply'
    permissions:
      id-token: write
      contents: read
    environment:
      name: prod
      url: https://console.aws.amazon.com/eks/home?region=us-east-1#/clusters/tekmetric-prod

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform and Terragrunt
        uses: ./.github/actions/terraform-setup

      - name: Assume AWS Role
        uses: ./.github/actions/aws-assume-role
        with:
          environment: prod
          role-arn: ${{ secrets.AWS_PROD_ROLE_ARN }}
          account-id: ${{ secrets.AWS_PROD_ACCOUNT_ID }}

      - name: Terragrunt Apply
        run: |
          cd sre/terragrunt/environments/prod
          terragrunt run-all apply --terragrunt-non-interactive

      - name: Summary
        run: |
          echo "## âœ… Prod Infrastructure Applied" >> $GITHUB_STEP_SUMMARY
          echo "**Cluster:** tekmetric-prod" >> $GITHUB_STEP_SUMMARY
          echo "**Region:** us-east-1" >> $GITHUB_STEP_SUMMARY

  summary:
    name: Workflow Summary
    runs-on: ubuntu-latest
    needs: [validate, plan-dev, apply-dev, plan-qa, apply-qa, plan-prod, apply-prod]
    if: always()

    steps:
      - name: Generate Summary
        run: |
          echo "## ðŸš€ Terraform Workflow Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Action:** ${{ github.event.inputs.action || 'plan' }}" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ github.event.inputs.environment || 'dev' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Job Status" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Validate | ${{ needs.validate.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Plan Dev | ${{ needs.plan-dev.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Apply Dev | ${{ needs.apply-dev.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Plan QA | ${{ needs.plan-qa.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Apply QA | ${{ needs.apply-qa.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Plan Prod | ${{ needs.plan-prod.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Apply Prod | ${{ needs.apply-prod.result }} |" >> $GITHUB_STEP_SUMMARY
