name: Terraform Apply

on:
  push:
    branches:
      - master
      - main
    paths:
      - 'sre/terraform/modules/**'
      - 'sre/terragrunt/environments/dev/**'
      # Uncomment when ready to enable QA
      # - 'sre/terragrunt/environments/qa/**'
      # Uncomment when ready to enable Prod
      # - 'sre/terragrunt/environments/prod/**'

  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to apply'
        required: true
        type: choice
        options:
          - dev
          - qa
          - prod

concurrency:
  group: terraform-apply-${{ inputs.environment || 'all' }}
  cancel-in-progress: false

jobs:
  apply-dev:
    name: Apply to Dev
    runs-on: ubuntu-latest
    if: github.event.inputs.environment == 'dev' || github.event.inputs.environment == ''
    environment:
      name: dev
      url: https://console.aws.amazon.com/eks/home?region=us-east-1#/clusters/tekmetric-dev
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform and Terragrunt
        uses: ./.github/actions/terraform-setup

      - name: Assume AWS Role
        uses: ./.github/actions/aws-assume-role
        with:
          environment: dev

      - name: Terragrunt Apply
        run: |
          cd sre/terragrunt/environments/dev
          terragrunt run-all apply --terragrunt-non-interactive

      - name: Summary
        run: |
          echo "## âœ… Dev Infrastructure Applied" >> $GITHUB_STEP_SUMMARY
          echo "**Cluster:** tekmetric-dev" >> $GITHUB_STEP_SUMMARY
          echo "**Region:** us-east-1" >> $GITHUB_STEP_SUMMARY

  apply-qa:
    name: Apply to QA
    runs-on: ubuntu-latest
    needs: apply-dev
    if: github.event.inputs.environment == 'qa' || (github.event.inputs.environment == '' && github.event_name == 'workflow_dispatch')
    environment:
      name: qa
      url: https://console.aws.amazon.com/eks/home?region=us-east-1#/clusters/tekmetric-qa
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform and Terragrunt
        uses: ./.github/actions/terraform-setup

      - name: Assume AWS Role
        uses: ./.github/actions/aws-assume-role
        with:
          environment: qa

      - name: Terragrunt Apply
        run: |
          cd sre/terragrunt/environments/qa
          terragrunt run-all apply --terragrunt-non-interactive

  apply-prod:
    name: Apply to Prod
    runs-on: ubuntu-latest
    needs: [apply-dev, apply-qa]
    if: github.event.inputs.environment == 'prod'
    environment:
      name: prod
      url: https://console.aws.amazon.com/eks/home?region=us-east-1#/clusters/tekmetric-prod
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform and Terragrunt
        uses: ./.github/actions/terraform-setup

      - name: Assume AWS Role
        uses: ./.github/actions/aws-assume-role
        with:
          environment: prod

      - name: Terragrunt Apply
        run: |
          cd sre/terragrunt/environments/prod
          terragrunt run-all apply --terragrunt-non-interactive

  summary:
    name: Apply Summary
    runs-on: ubuntu-latest
    needs: [apply-dev, apply-qa, apply-prod]
    if: always()

    steps:
      - name: Generate Summary
        run: |
          echo "## ðŸš€ Terraform Apply Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** [\`${GITHUB_SHA::8}\`](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Environment Status" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Dev | ${{ needs.apply-dev.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| QA | ${{ needs.apply-qa.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Prod | ${{ needs.apply-prod.result }} |" >> $GITHUB_STEP_SUMMARY
