name: Destroy Specific Module

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment (dev, qa, prod)'
        required: true
        type: choice
        options:
          - dev
          - qa
          - prod
      module:
        description: 'Module to destroy (e.g., ecr, iam, vpc)'
        required: true
        type: string
      confirm:
        description: 'Type module name to confirm (e.g., ecr)'
        required: true

concurrency:
  group: module-destroy-${{ inputs.environment }}-${{ inputs.module }}
  cancel-in-progress: false

jobs:
  validate:
    name: Validate Destroy Request
    runs-on: ubuntu-latest

    steps:
      - name: Validate confirmation
        run: |
          if [[ "${{ inputs.confirm }}" != "${{ inputs.module }}" ]]; then
            echo "âŒ ERROR: Confirmation failed."
            echo "Type '${{ inputs.module }}' to confirm destruction"
            exit 1
          fi

      - name: Warning
        run: |
          echo "âš ï¸ WARNING: This will destroy the ${{ inputs.module }} module"
          echo "Environment: ${{ inputs.environment }}"
          echo "Path: sre/terragrunt/environments/${{ inputs.environment }}/${{ inputs.module }}"
          echo ""
          echo "Sleeping for 5 seconds..."
          sleep 5

  destroy:
    name: Destroy ${{ inputs.module }} in ${{ inputs.environment }}
    runs-on: ubuntu-latest
    needs: validate
    environment: ${{ inputs.environment }}
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform and Terragrunt
        uses: ./.github/actions/terraform-setup

      - name: Assume AWS Role
        uses: ./.github/actions/aws-assume-role
        with:
          environment: ${{ inputs.environment }}
          role-arn: ${{ inputs.environment == 'dev' && secrets.AWS_DEV_ROLE_ARN || inputs.environment == 'qa' && secrets.AWS_QA_ROLE_ARN || secrets.AWS_PROD_ROLE_ARN }}
          account-id: ${{ inputs.environment == 'dev' && secrets.AWS_DEV_ACCOUNT_ID || inputs.environment == 'qa' && secrets.AWS_QA_ACCOUNT_ID || secrets.AWS_PROD_ACCOUNT_ID }}
          aws-region: us-east-1

      - name: Verify module path exists
        run: |
          MODULE_PATH="sre/terragrunt/environments/${{ inputs.environment }}/${{ inputs.module }}"

          if [ ! -d "$MODULE_PATH" ]; then
            echo "âŒ ERROR: Module path does not exist: $MODULE_PATH"
            echo ""
            echo "Available modules in ${{ inputs.environment }}:"
            ls -1 "sre/terragrunt/environments/${{ inputs.environment }}/" || echo "Environment directory not found"
            exit 1
          fi

          echo "âœ… Module path verified: $MODULE_PATH"

      - name: Show module info
        run: |
          MODULE_PATH="sre/terragrunt/environments/${{ inputs.environment }}/${{ inputs.module }}"
          cd "$MODULE_PATH"

          echo "ðŸ“‹ Module Information:"
          echo "Path: $(pwd)"
          echo ""
          echo "Terragrunt config:"
          cat terragrunt.hcl
          echo ""

      - name: Terragrunt plan destroy
        continue-on-error: true
        run: |
          MODULE_PATH="sre/terragrunt/environments/${{ inputs.environment }}/${{ inputs.module }}"
          cd "$MODULE_PATH"

          echo "ðŸ” Planning destroy for ${{ inputs.module }}..."
          terragrunt plan -destroy

      - name: Terragrunt destroy
        run: |
          MODULE_PATH="sre/terragrunt/environments/${{ inputs.environment }}/${{ inputs.module }}"
          cd "$MODULE_PATH"

          echo "ðŸ—‘ï¸ Destroying ${{ inputs.module }} module..."
          terragrunt destroy --terragrunt-non-interactive -auto-approve

      - name: Verify destruction
        run: |
          echo "ðŸ” Verifying ${{ inputs.module }} resources are destroyed..."

          # Module-specific verification
          case "${{ inputs.module }}" in
            ecr)
              echo "Checking ECR repositories..."
              REPOS=$(aws ecr describe-repositories --region us-east-1 --query 'repositories[*].repositoryName' --output text 2>/dev/null || echo "")
              if [ -z "$REPOS" ]; then
                echo "âœ… No ECR repositories found"
              else
                echo "âš ï¸ ECR repositories still exist: $REPOS"
              fi
              ;;
            eks)
              echo "Checking EKS cluster..."
              if aws eks describe-cluster --name tekmetric-${{ inputs.environment }} --region us-east-1 2>/dev/null; then
                echo "âš ï¸ EKS cluster still exists"
              else
                echo "âœ… EKS cluster destroyed"
              fi
              ;;
            vpc)
              echo "Checking VPC..."
              VPC_ID=$(aws ec2 describe-vpcs \
                --filters "Name=tag:Name,Values=tekmetric-${{ inputs.environment }}-vpc" \
                --query "Vpcs[0].VpcId" --output text 2>/dev/null || echo "None")
              if [ "$VPC_ID" != "None" ]; then
                echo "âš ï¸ VPC still exists: $VPC_ID"
              else
                echo "âœ… VPC destroyed"
              fi
              ;;
            *)
              echo "â„¹ï¸ No specific verification for ${{ inputs.module }}"
              ;;
          esac

      - name: Summary
        if: always()
        run: |
          echo "## ðŸ—‘ï¸ Module Destruction Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "**Module:** ${{ inputs.module }}" >> $GITHUB_STEP_SUMMARY
          echo "**Destroyed at:** $(date)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ job.status }}" == "success" ]]; then
            echo "âœ… **Status:** Module destroyed successfully" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Status:** Destruction failed" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "If you need to recreate this module:" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "cd sre/terragrunt/environments/${{ inputs.environment }}/${{ inputs.module }}" >> $GITHUB_STEP_SUMMARY
          echo "terragrunt apply" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
