name: Backend Service CD

on:
  workflow_run:
    workflows: ["Backend Service CI"]
    types: [completed]
    branches:
      - main
      - master
      - develop
      - 'release/**'
      - 'hotfix/**'

  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        type: choice
        options:
          - dev
          - qa
          - prod
      version:
        description: 'Image version tag (e.g., 1.0.123-abc12345-SNAPSHOT)'
        required: true
        type: string
      skip-tests:
        description: 'Skip post-deployment tests'
        required: false
        type: boolean
        default: false

# Cancel previous runs for the same branch
concurrency:
  group: backend-cd-${{ github.ref }}
  cancel-in-progress: false  # Don't cancel deployments

jobs:
  determine-environment:
    name: Determine Deployment Target
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    outputs:
      environment: ${{ steps.determine.outputs.environment }}
      version: ${{ steps.determine.outputs.version }}
      should-deploy: ${{ steps.determine.outputs.should-deploy }}
      image-ref: ${{ steps.determine.outputs.image-ref }}

    steps:
      - name: Download build metadata from CI
        if: github.event_name == 'workflow_run'
        uses: actions/github-script@v7
        with:
          script: |
            const allArtifacts = await github.rest.actions.listWorkflowRunArtifacts({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: ${{ github.event.workflow_run.id }},
            });

            const matchArtifact = allArtifacts.data.artifacts.filter((artifact) => {
              return artifact.name == "build-metadata"
            })[0];

            if (!matchArtifact) {
              core.setFailed('build-metadata artifact not found');
              return;
            }

            const download = await github.rest.actions.downloadArtifact({
              owner: context.repo.owner,
              repo: context.repo.repo,
              artifact_id: matchArtifact.id,
              archive_format: 'zip',
            });

            const fs = require('fs');
            fs.writeFileSync(`${process.env.GITHUB_WORKSPACE}/build-metadata.zip`, Buffer.from(download.data));

      - name: Extract build metadata
        if: github.event_name == 'workflow_run'
        run: |
          unzip build-metadata.zip -d build-metadata
          ls -la build-metadata/

      - name: Determine deployment target
        id: determine
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            # Manual dispatch - use inputs
            ENV="${{ inputs.environment }}"
            VERSION="${{ inputs.version }}"
            SHOULD_DEPLOY="true"
            BRANCH_NAME="manual"
          else
            # Automatic from CI - get metadata from artifact
            WORKFLOW_ID="${{ github.event.workflow_run.id }}"
            echo "CI Workflow Run ID: ${WORKFLOW_ID}"

            # Read all metadata from artifact
            VERSION=$(cat build-metadata/version.txt)
            IMAGE_REF=$(cat build-metadata/image-ref.txt)
            ENV=$(cat build-metadata/environment.txt)
            BRANCH_NAME=$(cat build-metadata/branch.txt)
            SHOULD_DEPLOY=$(cat build-metadata/should-deploy.txt)

            echo "ðŸ“¦ Version from CI: ${VERSION}"
            echo "ðŸ–¼ï¸  Image from CI: ${IMAGE_REF}"
            echo "ðŸŽ¯ Environment from CI: ${ENV}"
            echo "ðŸŒ¿ Branch from CI: ${BRANCH_NAME}"
            echo "ðŸš€ Should Deploy from CI: ${SHOULD_DEPLOY}"

            # Additional check for prod - always require manual approval
            if [[ "$ENV" == "prod" ]]; then
              SHOULD_DEPLOY="false"
              echo "âš ï¸  Production deployment requires manual approval"
              echo "   Run workflow_dispatch with environment=prod and version=${VERSION}"
            fi
          fi

          # For manual dispatch, construct image-ref
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            IMAGE_REF="${{ secrets.AWS_DEV_ACCOUNT_ID }}.dkr.ecr.us-east-1.amazonaws.com/backend:${VERSION}"
          fi

          echo "environment=${ENV}" >> $GITHUB_OUTPUT
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "should-deploy=${SHOULD_DEPLOY}" >> $GITHUB_OUTPUT
          echo "image-ref=${IMAGE_REF}" >> $GITHUB_OUTPUT

          echo "## ðŸŽ¯ Deployment Target" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** \`${ENV}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** \`${VERSION}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Auto-deploy:** \`${SHOULD_DEPLOY}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Image:** \`${IMAGE_REF}\`" >> $GITHUB_STEP_SUMMARY

  deploy-to-dev:
    name: Deploy to DEV
    runs-on: ubuntu-latest
    needs: determine-environment
    if: needs.determine-environment.outputs.environment == 'dev' && needs.determine-environment.outputs.should-deploy == 'true'
    environment:
      name: dev
      url: http://backend-dev.tekmetric.local
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: ./.github/actions/aws-assume-role
        with:
          environment: dev
          role-arn: ${{ secrets.AWS_DEV_ROLE_ARN }}
          account-id: ${{ secrets.AWS_DEV_ACCOUNT_ID }}
          aws-region: us-east-1

      - name: Deploy to EKS with Helm
        id: helm-deploy
        uses: ./.github/actions/helm-deploy
        with:
          cluster-name: tekmetric-dev
          aws-region: us-east-1
          release-name: backend
          chart-name: backend-service
          chart-repo-type: s3
          chart-repo-url: s3://tekmetric-helm-charts-dev/charts
          chart-repo-name: tekmetric-s3
          namespace: backend-services
          values-file: sre/helm/backend/values-dev.yaml
          image-repository: ${{ secrets.AWS_DEV_ACCOUNT_ID }}.dkr.ecr.us-east-1.amazonaws.com
          image-name: backend
          image-tag: ${{ needs.determine-environment.outputs.version }}
          image-pull-policy: Always
          timeout: 10m
          atomic: true
          wait: true

      - name: Run Smoke Tests
        if: ${{ !inputs.skip-tests }}
        run: |
          echo "ðŸ§ª Running post-deployment smoke tests..."

          # Wait for all pods to be ready
          echo "â³ Waiting for pods to be ready..."
          kubectl wait --for=condition=ready pod \
            -l app.kubernetes.io/name=backend \
            -n backend-services \
            --timeout=300s || {
              echo "âŒ Pods failed to become ready within 5 minutes"
              kubectl get pods -n backend-services -l app.kubernetes.io/name=backend
              kubectl describe pods -n backend-services -l app.kubernetes.io/name=backend
              exit 1
            }

          echo "âœ… Pods are ready"

          # Get service endpoint
          echo "ðŸ” Getting service endpoint..."
          SERVICE_NAME=$(kubectl get svc -n backend-services -l app.kubernetes.io/name=backend -o jsonpath='{.items[0].metadata.name}')
          echo "Service name: ${SERVICE_NAME}"

          # Test health endpoint via port-forward
          echo "ðŸ¥ Testing health endpoints..."
          kubectl port-forward -n backend-services svc/${SERVICE_NAME} 8080:8080 &
          PF_PID=$!

          # Wait for port-forward to be ready
          sleep 5

          # Test health endpoint
          echo "Testing /actuator/health..."
          if curl -f -s --max-time 10 http://localhost:8080/actuator/health; then
            echo "âœ… Health endpoint: OK"
          else
            echo "âŒ Health endpoint: FAILED"
            kill $PF_PID 2>/dev/null || true
            exit 1
          fi

          # Test liveness endpoint
          echo "Testing /actuator/health/liveness..."
          if curl -f -s --max-time 10 http://localhost:8080/actuator/health/liveness; then
            echo "âœ… Liveness endpoint: OK"
          else
            echo "âŒ Liveness endpoint: FAILED"
            kill $PF_PID 2>/dev/null || true
            exit 1
          fi

          # Test readiness endpoint
          echo "Testing /actuator/health/readiness..."
          if curl -f -s --max-time 10 http://localhost:8080/actuator/health/readiness; then
            echo "âœ… Readiness endpoint: OK"
          else
            echo "âŒ Readiness endpoint: FAILED"
            kill $PF_PID 2>/dev/null || true
            exit 1
          fi

          # Test application endpoint
          echo "Testing /api/welcome..."
          RESPONSE=$(curl -s --max-time 10 http://localhost:8080/api/welcome)
          if [[ "$RESPONSE" == *"Welcome"* ]]; then
            echo "âœ… Application endpoint: OK"
            echo "Response: $RESPONSE"
          else
            echo "âŒ Application endpoint: FAILED"
            echo "Response: $RESPONSE"
            kill $PF_PID 2>/dev/null || true
            exit 1
          fi

          # Test metrics endpoint
          echo "Testing /actuator/prometheus..."
          if curl -f -s --max-time 10 http://localhost:8080/actuator/prometheus | grep -q "jvm_memory_used_bytes"; then
            echo "âœ… Metrics endpoint: OK (Prometheus metrics available)"
          else
            echo "âŒ Metrics endpoint: FAILED"
            kill $PF_PID 2>/dev/null || true
            exit 1
          fi

          # Clean up port-forward
          kill $PF_PID 2>/dev/null || true

          echo ""
          echo "ðŸŽ‰ All smoke tests passed!"
          echo "âœ… Deployment verified and healthy"

      - name: Deployment summary
        if: always()
        run: |
          echo "## ðŸš€ DEV Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** DEV" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** \`${{ needs.determine-environment.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Image:** \`${{ steps.ecr-push.outputs.ecr-image-uri }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Namespace:** \`default\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Š Deployment Status" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ job.status }}" == "success" ]]; then
            echo "âœ… **Status:** Deployed successfully" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Status:** Deployment failed" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”— Quick Commands" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "# View pods" >> $GITHUB_STEP_SUMMARY
          echo "kubectl get pods -n default -l app.kubernetes.io/name=backend" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# View logs" >> $GITHUB_STEP_SUMMARY
          echo "kubectl logs -n default -l app.kubernetes.io/name=backend --tail=100" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Rollback" >> $GITHUB_STEP_SUMMARY
          echo "helm rollback backend -n default" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

  workflow-summary:
    name: Workflow Summary
    runs-on: ubuntu-latest
    needs: [determine-environment, deploy-to-dev]
    if: always()

    steps:
      - name: Generate Workflow Summary
        run: |
          echo "## ðŸš€ Backend CD Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Trigger:** \`${{ github.event_name }}\`" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ github.event_name }}" == "workflow_run" ]]; then
            echo "**CI Workflow:** [\`${{ github.event.workflow_run.name }}\`](${{ github.event.workflow_run.html_url }})" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Job Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY

          # Determine Environment
          if [[ "${{ needs.determine-environment.result }}" == "success" ]]; then
            echo "| Determine Environment | âœ… Success |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Determine Environment | âŒ Failed |" >> $GITHUB_STEP_SUMMARY
          fi

          # Deploy to DEV
          if [[ "${{ needs.deploy-to-dev.result }}" == "success" ]]; then
            echo "| Deploy to DEV | âœ… Success |" >> $GITHUB_STEP_SUMMARY
          elif [[ "${{ needs.deploy-to-dev.result }}" == "failure" ]]; then
            echo "| Deploy to DEV | âŒ Failed |" >> $GITHUB_STEP_SUMMARY
          elif [[ "${{ needs.deploy-to-dev.result }}" == "skipped" ]]; then
            echo "| Deploy to DEV | â­ï¸ Skipped |" >> $GITHUB_STEP_SUMMARY
          fi
