name: Backend Service CD

on:
  workflow_run:
    workflows: ["Backend Service CI"]
    types: [completed]
    branches: [main, master]

  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        type: choice
        options:
          - dev
          - qa
          - prod
      version:
        description: 'Image version tag (e.g., 1.0.123-abc12345-SNAPSHOT)'
        required: true
        type: string
      skip-tests:
        description: 'Skip post-deployment tests'
        required: false
        type: boolean
        default: false

# Cancel previous runs for the same branch
concurrency:
  group: backend-cd-${{ github.ref }}
  cancel-in-progress: false  # Don't cancel deployments

jobs:
  determine-environment:
    name: Determine Deployment Target
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    outputs:
      environment: ${{ steps.determine.outputs.environment }}
      version: ${{ steps.determine.outputs.version }}
      should-deploy: ${{ steps.determine.outputs.should-deploy }}
      image-ref: ${{ steps.determine.outputs.image-ref }}

    steps:
      - name: Download build metadata from CI
        if: github.event_name == 'workflow_run'
        uses: actions/github-script@v7
        with:
          script: |
            const allArtifacts = await github.rest.actions.listWorkflowRunArtifacts({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: ${{ github.event.workflow_run.id }},
            });

            const matchArtifact = allArtifacts.data.artifacts.filter((artifact) => {
              return artifact.name == "build-metadata"
            })[0];

            if (!matchArtifact) {
              core.setFailed('build-metadata artifact not found');
              return;
            }

            const download = await github.rest.actions.downloadArtifact({
              owner: context.repo.owner,
              repo: context.repo.repo,
              artifact_id: matchArtifact.id,
              archive_format: 'zip',
            });

            const fs = require('fs');
            fs.writeFileSync(`${process.env.GITHUB_WORKSPACE}/build-metadata.zip`, Buffer.from(download.data));

      - name: Extract build metadata
        if: github.event_name == 'workflow_run'
        run: |
          unzip build-metadata.zip -d build-metadata
          ls -la build-metadata/

      - name: Determine deployment target
        id: determine
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            # Manual dispatch - use inputs
            ENV="${{ inputs.environment }}"
            VERSION="${{ inputs.version }}"
            SHOULD_DEPLOY="true"
          else
            # Automatic from CI - get version from artifact
            WORKFLOW_ID="${{ github.event.workflow_run.id }}"
            echo "CI Workflow Run ID: ${WORKFLOW_ID}"

            # Read version and image-ref from artifact
            VERSION=$(cat build-metadata/version.txt)
            IMAGE_REF=$(cat build-metadata/image-ref.txt)

            echo "ðŸ“¦ Version from CI: ${VERSION}"
            echo "ðŸ–¼ï¸  Image from CI: ${IMAGE_REF}"

            # Determine environment based on version pattern
            if [[ "$VERSION" == *"SNAPSHOT"* ]]; then
              ENV="dev"
              SHOULD_DEPLOY="true"
            elif [[ "$VERSION" =~ ^v?[0-9]+\.[0-9]+\.[0-9]+-RC[0-9]+$ ]]; then
              ENV="qa"
              SHOULD_DEPLOY="true"
            elif [[ "$VERSION" =~ ^v?[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
              ENV="prod"
              SHOULD_DEPLOY="false"  # Prod requires manual approval
            else
              ENV="none"
              SHOULD_DEPLOY="false"
              echo "âš ï¸  Unknown version pattern: ${VERSION}"
            fi
          fi

          # For manual dispatch, construct image-ref
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            IMAGE_REF="ghcr.io/${{ github.repository_owner }}/backend:${VERSION}"
          fi

          echo "environment=${ENV}" >> $GITHUB_OUTPUT
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "should-deploy=${SHOULD_DEPLOY}" >> $GITHUB_OUTPUT
          echo "image-ref=${IMAGE_REF}" >> $GITHUB_OUTPUT

          echo "## ðŸŽ¯ Deployment Target" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** \`${ENV}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** \`${VERSION}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Auto-deploy:** \`${SHOULD_DEPLOY}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Image:** \`${IMAGE_REF}\`" >> $GITHUB_STEP_SUMMARY

  deploy-to-dev:
    name: Deploy to DEV
    runs-on: ubuntu-latest
    needs: determine-environment
    if: needs.determine-environment.outputs.environment == 'dev' && needs.determine-environment.outputs.should-deploy == 'true'
    environment:
      name: dev
      url: http://backend-dev.tekmetric.local
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: ./.github/actions/aws-assume-role
        with:
          environment: dev
          role-arn: ${{ secrets.AWS_DEV_ROLE_ARN }}
          account-id: ${{ secrets.AWS_DEV_ACCOUNT_ID }}
          aws-region: us-east-1

      - name: Login to GHCR
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

      - name: Login to ECR
        run: |
          echo "ðŸ” Logging in to ECR..."
          aws ecr get-login-password --region us-east-1 | \
            docker login --username AWS --password-stdin \
            ${{ secrets.AWS_DEV_ACCOUNT_ID }}.dkr.ecr.us-east-1.amazonaws.com
          echo "âœ… Logged in to ECR"

      - name: Push Image to ECR
        id: ecr-push
        run: |
          echo "ðŸ“¦ Pushing image to ECR..."

          SOURCE_IMAGE="${{ needs.determine-environment.outputs.image-ref }}"
          ECR_REGISTRY="${{ secrets.AWS_DEV_ACCOUNT_ID }}.dkr.ecr.us-east-1.amazonaws.com"
          ECR_REPO="backend"
          IMAGE_TAG="${{ needs.determine-environment.outputs.version }}"

          TARGET_IMAGE="${ECR_REGISTRY}/${ECR_REPO}:${IMAGE_TAG}"

          # Pull from GHCR
          docker pull "${SOURCE_IMAGE}"

          # Tag for ECR
          docker tag "${SOURCE_IMAGE}" "${TARGET_IMAGE}"

          # Push to ECR
          docker push "${TARGET_IMAGE}"

          echo "âœ… Pushed ${TARGET_IMAGE}"
          echo "ecr-image-uri=${TARGET_IMAGE}" >> $GITHUB_OUTPUT

      - name: Configure EKS access for Helm
        run: |
          echo "ðŸ”§ Configuring EKS access..."

          # Update kubeconfig WITHOUT assuming admin role
          # Uses GitHubActionsRole-dev credentials that are already configured
          aws eks update-kubeconfig \
            --name tekmetric-dev \
            --region us-east-1

          echo "âœ… EKS access configured"

      - name: Install helm-s3 plugin
        run: |
          echo "ðŸ“¦ Installing helm-s3 plugin..."
          helm plugin install https://github.com/hypnoglow/helm-s3.git --version 0.16.0
          helm plugin list

      - name: Add S3 Helm repository
        run: |
          BUCKET_NAME="tekmetric-helm-charts-dev"
          REPO_PATH="s3://${BUCKET_NAME}/charts"
          REPO_NAME="tekmetric-s3"

          echo "ðŸ“¦ Adding S3 Helm repository..."
          helm repo add ${REPO_NAME} ${REPO_PATH}
          helm repo update ${REPO_NAME}

          echo "âœ… Helm repository added and updated"
          echo "ðŸ“‹ Available charts:"
          helm search repo ${REPO_NAME} --versions | head -20

          # Verify backend-service chart is available
          if ! helm search repo ${REPO_NAME}/backend-service --versions | grep -q backend-service; then
            echo "âŒ ERROR: backend-service chart not found in S3 repository"
            echo "Checking S3 bucket contents..."
            aws s3 ls ${REPO_PATH}/ --recursive || true
            exit 1
          fi

          echo "âœ… backend-service chart is available"

      - name: Deploy to EKS with Helm
        id: helm-deploy
        run: |
          echo "ðŸš€ Deploying backend service to EKS..."

          RELEASE_NAME="backend"
          NAMESPACE="default"
          CHART="tekmetric-s3/backend-service"
          IMAGE_TAG="${{ needs.determine-environment.outputs.version }}"
          ECR_REGISTRY="${{ secrets.AWS_DEV_ACCOUNT_ID }}.dkr.ecr.us-east-1.amazonaws.com"

          # Helm uses existing kubeconfig (GitHubActionsRole-dev credentials)
          helm upgrade --install ${RELEASE_NAME} ${CHART} \
            --namespace ${NAMESPACE} \
            --create-namespace \
            --set tekmetric-common-chart.image.repository=${ECR_REGISTRY} \
            --set tekmetric-common-chart.image.name=backend \
            --set tekmetric-common-chart.image.tag=${IMAGE_TAG} \
            --set tekmetric-common-chart.image.pullPolicy=Always \
            --values sre/helm/backend/values-dev.yaml \
            --wait \
            --timeout 10m \
            --atomic \
            --cleanup-on-fail

          echo "âœ… Helm deployment completed successfully"
          echo "deployment-name=${RELEASE_NAME}" >> $GITHUB_OUTPUT

      - name: Deployment summary
        if: always()
        run: |
          echo "## ðŸš€ DEV Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** DEV" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** \`${{ needs.determine-environment.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Image:** \`${{ steps.ecr-push.outputs.ecr-image-uri }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Namespace:** \`default\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Š Deployment Status" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ job.status }}" == "success" ]]; then
            echo "âœ… **Status:** Deployed successfully" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Status:** Deployment failed" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”— Quick Commands" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "# View pods" >> $GITHUB_STEP_SUMMARY
          echo "kubectl get pods -n default -l app.kubernetes.io/name=backend" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# View logs" >> $GITHUB_STEP_SUMMARY
          echo "kubectl logs -n default -l app.kubernetes.io/name=backend --tail=100" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Rollback" >> $GITHUB_STEP_SUMMARY
          echo "helm rollback backend -n default" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

  workflow-summary:
    name: Workflow Summary
    runs-on: ubuntu-latest
    needs: [determine-environment, deploy-to-dev]
    if: always()

    steps:
      - name: Generate Workflow Summary
        run: |
          echo "## ðŸš€ Backend CD Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Trigger:** \`${{ github.event_name }}\`" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ github.event_name }}" == "workflow_run" ]]; then
            echo "**CI Workflow:** [\`${{ github.event.workflow_run.name }}\`](${{ github.event.workflow_run.html_url }})" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Job Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY

          # Determine Environment
          if [[ "${{ needs.determine-environment.result }}" == "success" ]]; then
            echo "| Determine Environment | âœ… Success |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Determine Environment | âŒ Failed |" >> $GITHUB_STEP_SUMMARY
          fi

          # Deploy to DEV
          if [[ "${{ needs.deploy-to-dev.result }}" == "success" ]]; then
            echo "| Deploy to DEV | âœ… Success |" >> $GITHUB_STEP_SUMMARY
          elif [[ "${{ needs.deploy-to-dev.result }}" == "failure" ]]; then
            echo "| Deploy to DEV | âŒ Failed |" >> $GITHUB_STEP_SUMMARY
          elif [[ "${{ needs.deploy-to-dev.result }}" == "skipped" ]]; then
            echo "| Deploy to DEV | â­ï¸ Skipped |" >> $GITHUB_STEP_SUMMARY
          fi
