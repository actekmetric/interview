name: 'ECR Provision and Push'
description: 'Provisions ECR repository via Terragrunt and pushes Docker image'
author: 'Tekmetric SRE'

inputs:
  repository-name:
    description: 'ECR repository name (e.g., backend, frontend)'
    required: true

  environment:
    description: 'Environment (dev, qa, prod)'
    required: true

  image-ref:
    description: 'Full Docker image reference to push (e.g., ghcr.io/org/backend:tag)'
    required: true

  image-tag:
    description: 'Semantic version tag for the image'
    required: true

  aws-region:
    description: 'AWS region'
    required: false
    default: 'us-east-1'

  max-image-count:
    description: 'Maximum number of tagged images to keep'
    required: false
    default: '10'

  untagged-expire-days:
    description: 'Days before untagged images expire'
    required: false
    default: '7'

  image-tag-mutability:
    description: 'Image tag mutability (MUTABLE or IMMUTABLE)'
    required: false
    default: 'MUTABLE'

  terragrunt-version:
    description: 'Terragrunt version'
    required: false
    default: 'v0.55.1'

  terraform-version:
    description: 'Terraform version'
    required: false
    default: '1.6.0'

outputs:
  ecr-repository-url:
    description: 'Full ECR repository URL'
    value: ${{ steps.get-outputs.outputs.repository-url }}

  ecr-image-uri:
    description: 'Full ECR image URI with tag'
    value: ${{ steps.get-outputs.outputs.image-uri }}

  terragrunt-changes:
    description: 'Whether Terragrunt made changes (true/false)'
    value: ${{ steps.terragrunt-apply.outputs.changes-made }}

runs:
  using: 'composite'
  steps:
    - name: Validate inputs
      shell: bash
      run: |
        echo "ðŸ” Validating inputs..."

        if [[ ! "${{ inputs.environment }}" =~ ^(dev|qa|prod)$ ]]; then
          echo "âŒ Error: environment must be dev, qa, or prod"
          exit 1
        fi

        if [[ ! "${{ inputs.image-tag-mutability }}" =~ ^(MUTABLE|IMMUTABLE)$ ]]; then
          echo "âŒ Error: image-tag-mutability must be MUTABLE or IMMUTABLE"
          exit 1
        fi

        echo "âœ… Inputs validated"

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: ${{ inputs.terraform-version }}
        terraform_wrapper: false

    - name: Setup Terragrunt
      shell: bash
      run: |
        echo "ðŸ“¦ Installing Terragrunt ${{ inputs.terragrunt-version }}..."

        wget -q https://github.com/gruntwork-io/terragrunt/releases/download/${{ inputs.terragrunt-version }}/terragrunt_linux_amd64
        chmod +x terragrunt_linux_amd64
        sudo mv terragrunt_linux_amd64 /usr/local/bin/terragrunt

        terragrunt --version
        echo "âœ… Terragrunt installed"

    - name: Create dynamic ECR Terragrunt config
      shell: bash
      run: |
        echo "ðŸ“ Creating dynamic ECR configuration..."

        ECR_DIR="sre/terragrunt/environments/${{ inputs.environment }}/ecr-dynamic"
        mkdir -p "${ECR_DIR}"

        cat > "${ECR_DIR}/terragrunt.hcl" <<'HCLEOF'
        include "root" {
          path = find_in_parent_folders()
        }

        terraform {
          source = "${get_repo_root()}/sre/terraform/modules/ecr"
        }

        # Override the remote state key to be unique per repository
        generate "backend_override" {
          path      = "backend_override.tf"
          if_exists = "overwrite"
          contents  = <<EOF
terraform {
  backend "s3" {
    key = "${path_relative_to_include()}/ecr-${{ inputs.repository-name }}/terraform.tfstate"
  }
}
EOF
        }

        locals {
          environment_vars = read_terragrunt_config(find_in_parent_folders("account.hcl"))
          region_vars      = read_terragrunt_config(find_in_parent_folders("region.hcl"))

          environment = local.environment_vars.locals.environment
          account_id  = local.environment_vars.locals.account_id
          region      = local.region_vars.locals.region
        }

        inputs = {
          repository_names = [
            "${{ inputs.repository-name }}",
          ]

          image_tag_mutability  = "${{ inputs.image-tag-mutability }}"
          scan_on_push         = true
          max_image_count      = ${{ inputs.max-image-count }}
          untagged_expire_days = ${{ inputs.untagged-expire-days }}

          github_actions_role_arns = [
            "arn:aws:iam::${local.account_id}:role/GitHubActionsRole-${local.environment}"
          ]

          tags = {
            Environment = local.environment
            ManagedBy   = "GitHub-Actions"
            Component   = "ECR"
            Service     = "${{ inputs.repository-name }}"
            region      = local.region
          }
        }
        HCLEOF

        echo "âœ… Dynamic config created at ${ECR_DIR}/terragrunt.hcl"

    - name: Terragrunt Plan
      id: terragrunt-plan
      shell: bash
      working-directory: sre/terragrunt/environments/${{ inputs.environment }}/ecr-dynamic
      run: |
        echo "ðŸ“‹ Running Terragrunt plan..."

        terragrunt plan -out=tfplan -detailed-exitcode > plan_output.txt 2>&1 || PLAN_EXIT=$?
        PLAN_EXIT=${PLAN_EXIT:-0}

        cat plan_output.txt

        # Exit code 0: No changes
        # Exit code 1: Error
        # Exit code 2: Changes present

        if [ $PLAN_EXIT -eq 0 ]; then
          echo "âœ… No changes needed for ECR repository"
          echo "has-changes=false" >> $GITHUB_OUTPUT
        elif [ $PLAN_EXIT -eq 2 ]; then
          echo "ðŸ“ Changes detected for ECR repository"
          echo "has-changes=true" >> $GITHUB_OUTPUT
        else
          echo "âŒ Terragrunt plan failed"
          exit 1
        fi

    - name: Terragrunt Apply
      id: terragrunt-apply
      if: steps.terragrunt-plan.outputs.has-changes == 'true'
      shell: bash
      working-directory: sre/terragrunt/environments/${{ inputs.environment }}/ecr-dynamic
      run: |
        echo "ðŸš€ Applying Terragrunt changes..."

        terragrunt apply tfplan

        echo "âœ… ECR repository provisioned/updated"
        echo "changes-made=true" >> $GITHUB_OUTPUT

    - name: Set outputs if no changes
      if: steps.terragrunt-plan.outputs.has-changes == 'false'
      shell: bash
      run: |
        echo "changes-made=false" >> $GITHUB_OUTPUT

    - name: Get ECR repository URL
      id: get-ecr-url
      shell: bash
      run: |
        echo "ðŸ” Getting ECR repository URL..."

        ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
        ECR_URL="${ACCOUNT_ID}.dkr.ecr.${{ inputs.aws-region }}.amazonaws.com/${{ inputs.repository-name }}"

        echo "repository-url=${ECR_URL}" >> $GITHUB_OUTPUT
        echo "âœ… ECR URL: ${ECR_URL}"

    - name: Login to Amazon ECR
      shell: bash
      run: |
        echo "ðŸ” Logging in to Amazon ECR..."

        aws ecr get-login-password --region ${{ inputs.aws-region }} | \
        docker login --username AWS --password-stdin \
          $(aws sts get-caller-identity --query Account --output text).dkr.ecr.${{ inputs.aws-region }}.amazonaws.com

        echo "âœ… Logged in to ECR"

    - name: Pull image from source registry
      shell: bash
      run: |
        echo "ðŸ“¥ Pulling image from source registry..."

        docker pull ${{ inputs.image-ref }}

        echo "âœ… Image pulled: ${{ inputs.image-ref }}"

    - name: Tag and push to ECR
      id: push-to-ecr
      shell: bash
      run: |
        ECR_REPO="${{ steps.get-ecr-url.outputs.repository-url }}"
        IMAGE_TAG="${{ inputs.image-tag }}"
        ENVIRONMENT="${{ inputs.environment }}"

        echo "ðŸ·ï¸  Tagging image for ECR..."

        # Tag with semantic version
        docker tag ${{ inputs.image-ref }} ${ECR_REPO}:${IMAGE_TAG}
        docker push ${ECR_REPO}:${IMAGE_TAG}
        echo "âœ… Pushed ${ECR_REPO}:${IMAGE_TAG}"

        # Tag with environment-specific latest
        docker tag ${{ inputs.image-ref }} ${ECR_REPO}:${ENVIRONMENT}-latest
        docker push ${ECR_REPO}:${ENVIRONMENT}-latest
        echo "âœ… Pushed ${ECR_REPO}:${ENVIRONMENT}-latest"

        echo "image-uri=${ECR_REPO}:${IMAGE_TAG}" >> $GITHUB_OUTPUT

    - name: Trigger ECR vulnerability scan
      continue-on-error: true
      shell: bash
      run: |
        echo "ðŸ” Triggering ECR vulnerability scan..."

        aws ecr start-image-scan \
          --repository-name ${{ inputs.repository-name }} \
          --image-id imageTag=${{ inputs.image-tag }} \
          --region ${{ inputs.aws-region }} \
          2>/dev/null || echo "âš ï¸  Scan already in progress or completed"

        echo "âœ… Vulnerability scan initiated"

    - name: Set final outputs
      id: get-outputs
      shell: bash
      run: |
        echo "repository-url=${{ steps.get-ecr-url.outputs.repository-url }}" >> $GITHUB_OUTPUT
        echo "image-uri=${{ steps.push-to-ecr.outputs.image-uri }}" >> $GITHUB_OUTPUT

    - name: Cleanup dynamic config
      if: always()
      shell: bash
      run: |
        echo "ðŸ§¹ Cleaning up dynamic Terragrunt config..."
        rm -rf sre/terragrunt/environments/${{ inputs.environment }}/ecr-dynamic
        echo "âœ… Cleanup complete"

    - name: Summary
      shell: bash
      run: |
        echo "## ðŸ“¦ ECR Provision and Push Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Repository:** \`${{ inputs.repository-name }}\`" >> $GITHUB_STEP_SUMMARY
        echo "**Environment:** \`${{ inputs.environment }}\`" >> $GITHUB_STEP_SUMMARY
        echo "**ECR URL:** \`${{ steps.get-ecr-url.outputs.repository-url }}\`" >> $GITHUB_STEP_SUMMARY
        echo "**Image URI:** \`${{ steps.push-to-ecr.outputs.image-uri }}\`" >> $GITHUB_STEP_SUMMARY
        echo "**Terragrunt Changes:** \`${{ steps.terragrunt-apply.outputs.changes-made || 'false' }}\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ·ï¸ Image Tags" >> $GITHUB_STEP_SUMMARY
        echo "- \`${{ inputs.image-tag }}\` (semantic version)" >> $GITHUB_STEP_SUMMARY
        echo "- \`${{ inputs.environment }}-latest\` (environment latest)" >> $GITHUB_STEP_SUMMARY

branding:
  icon: 'box'
  color: 'orange'
